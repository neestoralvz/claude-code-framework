# Docker Compose Override for Development/Testing
# This file provides additional configurations for different environments

version: '3.8'

services:
  # Development overrides for the main dashboard service
  ticket-dashboard:
    # Enable development mode
    environment:
      - NODE_ENV=development
      - DEBUG_ENABLED=true
      - VERBOSE_LOGGING=true
      - LOG_LEVEL=debug
    
    # Development port mappings (avoid conflicts)
    ports:
      - "${DEV_DASHBOARD_PORT:-3100}:3000"
      - "${DEV_ADMIN_PORT:-3101}:3001"
    
    # Mount source code for live development
    volumes:
      # Source code mounting for development
      - ./core:/app/core:rw
      - ./api:/app/api:rw
      - ./agents:/app/agents:rw
      - ./automation:/app/automation:rw
      - ./hooks:/app/hooks:rw
      
      # Configuration override
      - ./docker-config/development:/app/config/development:ro
    
    # Development command override
    command: ["nodemon", "deploy.js"]
    
    # Remove resource limits for development
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'

  # Debug container for troubleshooting
  debug-shell:
    image: alpine:3.18
    container_name: ticket-dashboard-debug
    restart: "no"
    
    command: >
      sh -c "
        apk add --no-cache curl jq netstat-nat procps;
        echo 'Debug shell ready. Available tools: curl, jq, netstat, ps';
        tail -f /dev/null;
      "
    
    volumes:
      - dashboard-data:/debug/data:ro
      - dashboard-logs:/debug/logs:ro
      - dashboard-metrics:/debug/metrics:ro
      - ${CLAUDE_DATA_DIR:-/Users/nalve/.claude}:/debug/claude-data:ro
    
    networks:
      - dashboard-network

  # Testing service
  integration-tests:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: ticket-dashboard-tests
    restart: "no"
    
    environment:
      - NODE_ENV=test
      - CLAUDE_BASE_DIR=/claude-data
    
    command: ["npm", "test"]
    
    volumes:
      - ${CLAUDE_DATA_DIR:-/Users/nalve/.claude}:/claude-data:ro
      - ./test-results:/app/test-results:rw
    
    networks:
      - dashboard-network
    
    depends_on:
      - ticket-dashboard

# Development-specific volumes
volumes:
  # Test results volume
  test-results:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker-volumes/test-results